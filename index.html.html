<!DOCTYPE html>
<html lang="id">
<head>
  <script type="module">import { injectIntoGlobalHook } from "/@react-refresh"
injectIntoGlobalHook(window);
window.$RefreshReg$ = () => {};
window.$RefreshSig$ = () => (type) => type;</script>

  <script type="module" src="/@vite/client"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Kartu Pendukung Setia </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <!-- jsPDF and html2canvas libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --hijau-gelap: #004d40;
            --hijau-utama: #00695c;
            /* Brighter yellow gradient for card borders as requested */
            --gold-gradient: linear-gradient(145deg, #FAD961, #F7F2B1, #E8C14E);
            --hijau-gradient: linear-gradient(145deg, #00695c, #004d40);
            --gelap: #212529;
            --abu-terang: #f8f9fa;
            --putih: #ffffff;
            --lebar-kartu: 85.6mm;
            --tinggi-kartu: 53.98mm;
            --sidebar-width: 240px;

            /* New CSS variables for card colors */
            --card-front-bg: var(--hijau-gradient); /* Default to existing green gradient */
            --card-back-bg: var(--hijau-gradient);  /* Default to existing green gradient */
            --card-front-text-color: var(--putih);
            --card-back-text-color: var(--putih);
            --card-front-border-image: var(--gold-gradient);
            --card-back-border-image: var(--gold-gradient);
            --card-front-data-label-color: var(--putih);
            --card-front-data-value-color: var(--putih);
            --card-front-expiry-color: var(--putih);
            --card-back-party-name-color: var(--putih);
            --card-back-member-name-color: var(--putih);

            /* Dark Mode Variables */
            --body-bg: var(--abu-terang);
            --text-color: var(--gelap);
            --container-bg: var(--putih);
            --border-color: #e9ecef;
            --sidebar-bg: var(--gelap);
            --sidebar-text: var(--putih);
            --sidebar-active-bg: var(--hijau-utama);
            --sidebar-active-text: var(--gelap);
            --table-header-bg: var(--hijau-gelap);
            --table-header-text: var(--putih);
            --table-row-even-bg: #fdfdfd;
            --table-row-hover-bg: #f0f0f0;
            --input-border: #ced4da;
            --input-focus-shadow: rgba(0, 105, 92, 0.2);
            --login-bg: var(--abu-terang);
            --login-box-bg: var(--putih);
        }

        body.dark-mode {
            --body-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --container-bg: #2c2c2c;
            --border-color: #444;
            --sidebar-bg: #333;
            --sidebar-text: #e0e0e0;
            --sidebar-active-bg: #00796b;
            --sidebar-active-text: #ffffff;
            --table-header-bg: #00332e;
            --table-header-text: #e0e0e0;
            --table-row-even-bg: #222;
            --table-row-hover-bg: #3a3a3a;
            --input-border: #555;
            --input-focus-shadow: rgba(0, 121, 107, 0.4);
            --login-bg: #1a1a1a;
            --login-box-bg: #2c2c2c;
        }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0; 
            background-color: var(--body-bg); 
            display: flex; 
            height: 100vh;
            color: var(--text-color);
            flex-direction: row;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .hidden {
            display: none !important;
        }

        .sidebar {
            width: var(--sidebar-width); background-color: var(--sidebar-bg); color: var(--sidebar-text);
            flex-shrink: 0; display: flex; flex-direction: column; padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar-header { 
            text-align: center; padding: 0 20px 20px 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .sidebar-header h3 { margin: 0; font-size: 1.3em; font-weight: 700; }
        .sidebar-menu { list-style: none; margin: 0; padding: 0; }
        .sidebar-menu li a {
            display: flex; align-items: center; gap: 15px; padding: 15px 20px;
            color: var(--sidebar-text); text-decoration: none; transition: background-color 0.2s, border-left-color 0.2s, color 0.2s;
            border-left: 3px solid transparent;
            font-weight: 600;
        }
        .sidebar-menu li a:hover { background-color: #495057; }
        .sidebar-menu li a.active { background-color: var(--sidebar-active-bg); border-left-color: #f1e05a; color: var(--sidebar-active-text); }
        .sidebar-menu li a svg { width: 24px; height: 24px; fill: currentColor; }
        .sidebar-menu li a.active svg { fill: var(--sidebar-active-text); }
        .main-content {
            flex-grow: 1; padding: 30px; overflow-y: auto;
            background-color: var(--body-bg);
            transition: background-color 0.3s ease;
        }
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .container-box {
            background-color: var(--container-bg); padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        h2 {
            font-size: 1.8em; color: var(--hijau-gelap); margin: 0 0 25px 0; padding-bottom: 15px;
            border-bottom: 2px solid var(--hijau-utama);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-color);
            font-size: 0.95em;
        }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea,
        .form-group input[type="color"] {
            width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        .form-group input[type="file"] {
            width: 100%; padding: 10px;
            background-color: var(--body-bg);
            cursor: pointer;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 1em;
            color: var(--text-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-group input[type="color"]:focus {
            border-color: var(--hijau-utama);
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
            outline: none;
        }
        .form-buttons {
            display: flex; gap: 15px; margin-top: 30px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em;
            font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary { background-color: var(--hijau-utama); color: var(--putih); }
        .btn-primary:hover { background-color: var(--hijau-gelap); box-shadow: 0 2px 8px rgba(0, 105, 92, 0.4); }
        .btn-secondary { background-color: #6c757d; color: var(--putih); }
        .btn-secondary:hover { background-color: #5a6268; box-shadow: 0 2px 8px rgba(108, 122, 129, 0.4); }
        .btn-warning {
            background-image: var(--gold-gradient); color: var(--gelap); border: 1px solid #b38728;
            box-shadow: 0 2px 8px rgba(179, 135, 40, 0.4);
        }
        .btn-warning:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-danger { background-color: #dc3545; color: var(--putih); }
        .btn-danger:hover { background-color: #c82333; }
        
        .card-preview-area {
            display: flex; justify-content: center; flex-wrap: wrap; gap: 30px;
            margin-top: 15px;
        }

        .card-container {
            width: var(--lebar-kartu);
            height: var(--tinggi-kartu);
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            box-shadow: 0 15px 10px rgba(0,0,0,0.2);
            border-radius: 4mm;
            padding: 1px;
            background: var(--gold-gradient);
        }

        .card-content {
            position: relative;
            z-index: 1;
            padding: 4mm;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            justify-content: space-between;
            width: 100%;
            background: var(--card-front-bg); 
            color: var(--card-front-text-color);
            border-radius: calc(4mm - 2px);
        }

        .back-card .card-content {
            background: var(--card-back-bg);
            color: var(--card-back-text-color);
            align-items: center;
            justify-content: space-between;
            padding-top: 4mm;
            padding-bottom: 4mm;
        }

        .title-box {
            text-align: center; margin-bottom: 2mm;
            background: var(--gold-gradient); color: var(--gelap); padding: 1mm;
            border: 1px solid rgba(240, 5, 5, 0.2); border-radius: 1mm;
            font-weight: 700; text-transform: uppercase; font-size: 2.8mm;
            text-shadow: 0px 1px 1px rgba(255, 255, 255, 0.5);
            letter-spacing: 0.3px;
        }
        .front-card-main {
            display: flex; flex-grow: 1; gap: 3mm; align-items: flex-start;
            margin-bottom: 3mm;
        }
        .data-grid {
            flex-grow: 1; display: grid; font-size: 2mm;
            grid-template-columns: 26mm auto 1fr;
            gap: 0.5mm 2mm; 
            align-items: start; 
        }
        .data-grid span:nth-child(3n-2) { font-weight: 600; color: var(--card-front-data-label-color); }
        .data-grid span:nth-child(3n) { color: var(--card-front-data-value-color); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .data-grid .alamat-value {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .photo-area { text-align: right; }
        .photo-box {
            width: 20mm; height: 25mm;
            overflow: hidden; margin-bottom: 1.5mm; padding: 1px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgb(255, 255, 255);
        }
        .photo-box img {
            width: 100%; height: 100%; -o-object-fit: cover; object-fit: cover;
            display: block;
        }
        .expiry-date {
            font-size: 2mm; font-style: italic; text-align: center;
            color: var(--card-front-expiry-color);
        }
        .id-box {
            background: var(--gold-gradient); color: var(--gelap);
            padding: 1.5mm 3mm;
            border: 1px solid rgba(0,0,0,0.2); border-radius: 1mm;
            font-weight: 700; text-align: center;
            font-size: 2.8mm;
            width: -moz-fit-content;
            width: fit-content;
            max-width: 32mm;
            position: absolute;
            bottom: 3mm;
            left: 5mm;
            height: 5mm;
            padding-left: 2mm;
            padding-right: 2mm;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .back-card-header {
            text-align: center;
            line-height: 1.3;
            margin-bottom: 5mm;
        }
        .member-name-box {
            font-weight: 700;
            font-size: 2.8mm;
            text-transform: uppercase;
            color: var(--card-back-member-name-color);
        }
        .party-name-box {
            font-weight: 700;
            font-size: 3.0mm;
            text-transform: uppercase;
            color: var(--card-back-party-name-color);
        }
        .back-images {
            display: flex;
            gap: 3mm;
            margin-top: -2.5mm;
            margin-bottom: 20mm;
            justify-content: center;
            width: 100%;
        }
        .back-images .photo-box {
            width: 20mm;
            height: 25mm;
            margin-bottom: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.1);
        }
        .back-images .photo-box img { -o-object-fit: contain; object-fit: contain; }
        .tagline-box {
            position: absolute;
            bottom: 3mm;
            left: 5%;
            width: 90%;
            background: var(--gold-gradient);
            color: var(--gelap);
            padding: 2mm;
            border: 1px solid rgba(0,0,0,0.2);
            font-weight: 700;
            text-align: center;
            font-size: 3mm;
            text-transform: uppercase;
            text-shadow: 0px 1px 1px rgba(255, 255, 255, 0.5);
            letter-spacing: 0.3px;
            height: 7mm;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rekap-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .rekap-filters .btn { padding: 10px 20px; }
        .search-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            flex-grow: 1;
            justify-content: flex-end;
            max-width: 350px;
        }
        .search-filter label {
            margin-bottom: 0;
            font-weight: 600;
            color: var(--text-color);
        }
        .search-filter input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 0.95em;
            min-width: 150px;
            flex-grow: 1;
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        .search-filter input:focus {
            border-color: var(--hijau-utama);
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
            outline: none;
        }
        .rekap-table-wrapper {
            max-height: 600px;
            overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;
            background-color: var(--container-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            position: sticky; top: 0; z-index: 2;
            font-weight: 700;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        tr:hover { background-color: var(--table-row-hover-bg); }

        td input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 5px;
            vertical-align: middle;
            cursor: pointer;
            accent-color: var(--hijau-utama);
        }

        .action-buttons button {
            padding: 8px 12px; margin-right: 5px; color: white; border: none; border-radius: 4px; cursor: pointer;
            font-size: 0.9em; transition: background-color 0.2s ease;
        }
        .edit-btn { background-color: var(--hijau-utama); }
        .edit-btn:hover { background-color: var(--hijau-gelap); }
        .delete-btn { background-color: #6c757d; }
        .delete-btn:hover { background-color: #5a6268; }
        #age-chart-container {
            max-width: 600px;
            margin: 20px auto;
        }
        #category-details-container {
            margin-top: 20px;
        }
        .category-section {
            margin-bottom: 20px;
        }
        .category-section h3 {
            font-size: 1.4em;
            color: var(--hijau-gelap);
            margin-bottom: 10px;
        }
        .category-list {
            list-style: none;
            padding: 0;
        }
        .category-list li {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }
        #print-area { display: none; }
        
        @media print {
            body {
                display: block;
                font-family: 'Arial', sans-serif;
                margin: 0;
                background-color: white;
                color: rgb(254, 254, 254);
            }
            .sidebar,
            .main-content > *:not(#print-area),
            #darkModeToggleSidebar { /* Sembunyikan tombol dark mode saat mencetak */
                display: none !important;
            }
            #print-area {
                display: block !important;
                width: 100%;
                margin: 0;
                height: auto;
            }
            .duplex-pair {
                display: flex;
                gap: 2mm;
                page-break-inside: avoid;
                width: -moz-fit-content;
                width: fit-content;
            }

            .card-container {
                box-shadow: none;
                margin: 0;
                transform-origin: top left;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 2px;
                background: var(--gold-gradient);
                border-radius: 4mm;
            }
            .card-content {
                padding: 3mm;
                font-size: 0.92em;
                background: var(--card-front-bg);
                color: var(--card-front-text-color);
                border-radius: calc(4mm - 2px);
            }
            .back-card .card-content {
                background: var(--card-back-bg);
                color: var(--card-back-text-color);
            }
            
            .title-box, .id-box, .tagline-box {
                background: var(--gold-gradient);
                color: var(--gelap);
                text-shadow: none;
                font-size: 0.92em;
            }
            .data-grid span:nth-child(3n-2) { color: var(--card-front-data-label-color); }
            .data-grid span:nth-child(3n) { color: var(--card-front-data-value-color); }
            .expiry-date { color: var(--card-front-expiry-color); }
            .member-name-box { color: var(--card-back-member-name-color); }
            .party-name-box { color: var(--card-back-party-name-color); }

            @page {
                size: A4 portrait;
                margin: 5mm 18.4mm;
            }
            .print-page {
                page-break-after: always;
                display: flex !important;
                flex-wrap: wrap;
                gap: 2mm 2mm;
                justify-content: flex-start;
                align-items: flex-start;
                align-content: flex-start;
                height: auto;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 10px 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .sidebar-header {
                display: none;
            }
            .sidebar-menu {
                flex-direction: row;
                width: 100%;
                justify-content: center;
                gap: 10px;
            }
            .sidebar-menu li a {
                padding: 10px 15px;
                font-size: 0.9em;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            .sidebar-menu li a.active {
                border-left: none;
                border-bottom-color: #eed309;
            }
            .sidebar-menu li a span {
                display: none;
            }
            .sidebar-menu li a svg {
                width: 20px;
                height: 20px;
            }
            .main-content {
                padding: 15px;
            }
            .container-box {
                padding: 20px;
            }
            h2 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .form-buttons, .rekap-filters {
                flex-direction: column;
                align-items: stretch;
            }
            .search-filter {
                flex-direction: column;
                align-items: stretch;
                margin-left: 0;
                width: 100%;
                max-width: none;
            }
            .rekap-table-wrapper {
                overflow-x: auto;
            }
            table {
                min-width: 600px;
            }
            .card-preview-area {
                flex-direction: column;
                align-items: center;
            }
        }

        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--login-bg);
            z-index: 1000;
            transition: background-color 2s ease-in-out;
        }
        .login-box {
            background-color: var(--login-box-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .login-box h2 {
            color: var(--hijau-gelap);
            margin-bottom: 30px;
            border-bottom: none;
            padding-bottom: 0;
        }
        .login-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .login-box .form-group label {
            font-size: 1em;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .login-box .form-group input {
            padding: 12px;
            font-size: 1.1em;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        .login-box .btn-primary {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border-radius: 8px;
        }
        .login-error {
            color: #dc3545;
            margin-top: 15px;
            font-weight: 600;
        }

        /* Digital Clock Styling */
        .digital-clock {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--sidebar-text);
            margin-top: 10px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            width: 100%; /* Ensure it takes full width */
        }
        body.dark-mode .digital-clock {
            color: var(--sidebar-text); /* Ensure clock color adapts to dark mode */
        }

        /* Dark Mode Toggle Button (Sidebar) */
        #darkModeToggleSidebar {
            margin-top: 10px;
            margin-bottom: 15px;
            padding: 8px 15px;
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #darkModeToggleSidebar:hover {
            background-color: var(--hijau-gelap);
            color: var(--putih);
        }
        #darkModeToggleSidebar svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <h2>Login Dasbor KPS</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="login-error-message" class="login-error hidden">Username atau password salah.</p>
            </form>
        </div>
    </div>

    <nav class="sidebar hidden" aria-label="Navigasi utama" id="app-sidebar">
        <div class="sidebar-header">
            <h3>Dasbor KPS</h3>
            <div id="digitalClock" class="digital-clock"></div> <!-- Digital Clock Element -->
            <!-- Dark Mode Toggle Button (Sidebar) -->
            <button id="darkModeToggleSidebar" aria-label="Toggle dark mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.183a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 001.06 1.06l1.591-1.59zM12 18.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V19.5a.75.75 0 01.75-.75zM4.929 6.183a.75.75 0 00-1.06 1.06l1.59 1.59a.75.75 0 101.06-1.06L4.929 6.183zm13.432 5.714a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H19.5a.75.75 0 01-.75-.75zM4.5 12a.75.75 0 01-.75-.75H2.25a.75.75 0 010-1.5H3.75a.75.75 0 01.75.75zM6.183 18.894a.75.75 0 001.06-1.06l-1.59-1.59a.75.75 0 00-1.06 1.06l1.59 1.59z" />
                </svg>
                <span>Mode Gelap</span>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#input" class="nav-link active" aria-current="page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                <span>Input Pendukung</span>
            </a></li>
            <li><a href="#rekap" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-6h-8v6zm0-18v6h8V3h-8z"/></svg>
                <span>Rekap Data</span>
            </a></li>
            <li><a href="#pengaturan" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.30-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42.12.64l2 3.46c.12.22.39.30.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59-1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                <span>Pengaturan Kartu</span>
            </a></li>
            <li><a href="#" id="logout-link" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                <span>Logout</span>
            </a></li>
        </ul>
    </nav>
    <main class="main-content hidden" id="app-main-content">
        <div id="input" class="page active">
            <div class="container-box">
                <h2 id="form-title">Tambah Pendukung Baru</h2>
                <form id="pendukung-form" aria-label="Formulir input data pendukung">
                    <div class="form-grid">
                        <input type="hidden" id="edit-id">
                        <div class="form-group"><label for="nama">Nama Lengkap</label><input type="text" id="nama" required aria-required="true"></div>
                        <div class="form-group"><label for="nik">NIK (16 Digit)</label><input type="text" id="nik" pattern="\d{16}" required title="NIK harus terdiri dari 16 digit angka." aria-required="true" maxlength="16"></div>
                        <div class="form-group"><label for="jenis_kelamin">Jenis Kelamin</label><select id="jenis_kelamin" required aria-required="true"><option value="">Pilih...</option><option>Laki-laki</option><option>Perempuan</option></select></div>
                        <div class="form-group"><label for="tempat_lahir">Tempat Lahir</label><input type="text" id="tempat_lahir" required aria-required="true"></div>
                        <div class="form-group"><label for="tanggal_lahir">Tanggal Lahir</label><input type="date" id="tanggal_lahir" required aria-required="true"></div>
                        <div class="form-group"><label for="kecamatan">Kecamatan</label><select id="kecamatan" required aria-required="true"><option value="">Pilih...</option><option>Jongkat</option><option>Segedong</option></select></div>
                        <div class="form-group"><label for="alamat">Alamat</label><textarea id="alamat" rows="3" required aria-required="true"></textarea></div>
                        <div class="form-group"><label for="foto_pendukung_upload">Foto Pendukung (2x2.5 cm)</label><input type="file" id="foto_pendukung_upload" accept="image/*" aria-describedby="foto-help"></div>
                        <small id="foto-help" class="form-text text-muted">Unggah foto berukuran 2x2.5 cm untuk kartu pendukung.</small>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="submit-btn" class="btn btn-primary" aria-label="Simpan data pendukung">Simpan</button>
                        <button type="button" id="update-btn" class="btn btn-warning hidden" aria-label="Perbarui data pendukung">Update</button>
                        <button type="button" id="cancel-btn" class="btn btn-secondary" aria-label="Batalkan pengisian formulir">Batal</button>
                    </div>
                </form>
            </div>
            <div class="container-box">
                <h2>Pratinjau Kartu</h2>
                <div class="card-preview-area">
                    <div id="review-front-card" class="card-container front-card"><p style="text-align: center; width: 100%; padding: 20px; color: var(--gelap);">Pratinjau Kartu Depan</p></div>
                    <div id="review-back-card" class="card-container back-card"><p style="text-align: center; width: 100%; padding: 20px; color: var(--gelap);">Pratinjau Kartu Belakang</p></div>
                </div>
            </div>
        </div>

        <div id="rekap" class="page">
            <div class="container-box">
                <h2>Rekapitulasi Data Pendukung</h2>
                <div class="rekap-filters">
                    <button class="btn btn-primary filter-btn" data-filter="semua" aria-label="Tampilkan semua data pendukung">Semua</button>
                    <button class="btn btn-secondary filter-btn" data-filter="Jongkat" aria-label="Tampilkan pendukung Kecamatan Jongkat">Jongkat</button>
                    <button class="btn btn-secondary filter-btn" data-filter="Segedong" aria-label="Tampilkan pendukung Kecamatan Segedong">Segedong</button>
                    <button class="btn btn-secondary filter-btn" data-filter="Pemula" aria-label="Tampilkan pendukung usia pemula">Pemula (17-35)</button>
                    <button class="btn btn-secondary filter-btn" data-filter="Dewasa" aria-label="Tampilkan pendukung usia dewasa">Dewasa (36-60)</button>
                    <button class="btn btn-secondary filter-btn" data-filter="Senior" aria-label="Tampilkan pendukung usia senior">Senior (61-95)</button>
                    <div class="search-filter">
                        <label for="search-input">Cari:</label>
                        <input type="text" id="search-input" placeholder="NIK, ID, Nama, Alamat..." aria-label="Cari berdasarkan NIK, ID, nama, atau alamat">
                    </div>
                </div>
                <div class="form-buttons" style="margin-bottom: 20px;">
                    <button id="exportCSVBtn" class="btn btn-primary" aria-label="Ekspor data pendukung ke CSV">Ekspor ke CSV</button>
                    <button id="downloadPdfBtn" class="btn btn-secondary" aria-label="Unduh data pendukung ke PDF">Unduh PDF</button>
                    <button id="downloadCardsBtn" class="btn btn-warning" aria-label="Download kartu pendukung yang dipilih">Download Kartu</button>
                    <button id="printFrontBtn" class="btn btn-secondary" aria-label="Cetak kartu depan">Cetak Depan Saja</button>
                    <button id="printBackBtn" class="btn btn-secondary" aria-label="Cetak kartu belakang">Cetak Belakang Saja</button>
                    <button id="printDuplexBtn" class="btn btn-primary" aria-label="Cetak kartu depan dan belakang">Cetak Depan-Belakang</button>
                </div>
                <div class="rekap-table-wrapper">
                    <table aria-label="Tabel rekapitulasi data pendukung">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-checkbox" title="Pilih Semua" aria-label="Pilih semua kartu untuk dicetak"></th>
                                <th>No</th>
                                <th>ID Pendukung</th>
                                <th>Nama</th>
                                <th>NIK</th> 
                                <th>Kecamatan</th>
                                <th>Alamat</th>
                                <th>Usia</th>
                                <th>Kategori</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rekap-table-body">
                            <tr>
                                <td colspan="10" style="text-align: center;">Memuat data...</td> </tr>
                        </tbody>
                    </table>
                </div>
                <div id="age-chart-container" class="container-box">
                    <h2>Distribusi Kategori Usia Pendukung</h2>
                    <canvas id="ageChart" aria-label="Diagram batang distribusi kategori usia pendukung"></canvas>
                </div>
                <div id="category-details-container" class="container-box">
                    <h2>Detail Pendukung per Kategori Usia</h2>
                    <div id="category-details"></div>
                </div>
            </div>
        </div>

        <div id="pengaturan" class="page">
            <div class="container-box">
                <h2>Pengaturan Kartu</h2>
                <form id="settings-form" aria-label="Formulir pengaturan kartu">
                    <div class="form-grid">
                        <div class="form-group"><label for="setting_nama_anggota">Nama Anggota DPRD</label><input type="text" id="setting_nama_anggota" aria-required="true"></div>
                        <div class="form-group"><label for="setting_dprd_photo_upload">Foto Anggota (2x2.5 cm)</label><input type="file" id="setting_dprd_photo_upload" accept="image/*" aria-describedby="dprd-photo-help"></div>
                        <div class="form-group"><label for="setting_pkb_logo_upload">Logo Partai (2x2.5 cm)</label><input type="file" id="setting_pkb_logo_upload" accept="image/*" aria-describedby="pkb-logo-help"></div>
                        <div class="form-group">
                            <label for="setting_card_title">Judul Kartu Depan</label>
                            <input type="text" id="setting_card_title" placeholder="Contoh: KARTU LOYALIS PENDUKUNG SETIA" aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="setting_front_card_color">Warna Latar Depan Kartu</label>
                            <input type="color" id="setting_front_card_color" value="#00695c">
                        </div>
                        <div class="form-group">
                            <label for="setting_back_card_color">Warna Latar Belakang Kartu</label>
                            <input type="color" id="setting_back_card_color" value="#00695c">
                        </div>
                        <div class="form-group">
                            <label for="setting_front_card_text_color">Warna Teks Depan Kartu</label>
                            <input type="color" id="setting_front_card_text_color" value="#ffffff">
                        </div>
                        <div class="form-group">
                            <label for="setting_back_card_text_color">Warna Teks Belakang Kartu</label>
                            <input type="color" id="setting_back_card_text_color" value="#ffffff">
                        </div>
                        <div class="form-group">
                            <label>Nomor ID Pendukung Berikutnya</label>
                            <div id="next-id-counters">
                                <!-- Counters for each district will be rendered here by JS -->
                            </div>
                        </div>
                        <small id="dprd-photo-help" class="form-text text-muted">Unggah foto anggota DPRD berukuran 2x2.5 cm.</small>
                        <small id="pkb-logo-help" class="form-text text-muted">Unggah logo partai berukuran 2x2.5 cm.</small>
                    </div>
                    <div class="form-buttons">
                        <button type="button" id="save-settings-btn" class="btn btn-primary" aria-label="Simpan pengaturan kartu">Simpan Pengaturan</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="templates" style="display: none;">
        <div class="card-container front-card" id="frontCardTemplate">
            <div class="card-content">
                <div class="title-box">KARTU LOYALIS PENDUKUNG SETIA</div>
                <div class="front-card-main">
                    <div class="data-grid">
                        <span>Nama</span><span>:</span><span data-field="nama"></span>
                        <span>NIK</span><span>:</span><span data-field="nik"></span>
                        <span>Jenis Kelamin</span><span>:</span><span data-field="jenis_kelamin"></span>
                        <span>Tempat/Tgl Lahir</span><span>:</span><span data-field="ttl"></span>
                        <span>Alamat</span><span>:</span><span data-field="alamat" class="alamat-value"></span>
                        <span>Usia</span><span>:</span><span data-field="usia"></span>
                    </div>
                    <div class="photo-area">
                        <div class="photo-box"><img data-field="foto" src="" alt="Foto Pendukung" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/84ce1a16-2d0e-4e47-990f-d997e304cb2a.png"></div>
                        <div class="expiry-date">Berlaku Sejak: <span data-field="berlaku"></span></div>
                    </div>
                </div>
                <div class="id-box"><span data-field="no_pendukung"></span></div>
            </div>
        </div>
        <div class="card-container back-card" id="backCardTemplate">
            <div class="card-content">
                <div class="back-card-header">
                    <div class="party-name-box">PARTAI KEBANGKITAN BANGSA</div>
                    <div class="member-name-box" data-field="namaAnggotaDPRD"></div>
                </div>
                <div class="back-images">
                    <div class="image-item">
                        <div class="photo-box"><img data-field="dprdPhoto" src="" alt="Foto Anggota DPRD" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/c4c1ac93-384a-49bd-885e-6abcca155fa7.png"></div>
                    </div>
                    <div class="image-item">
                        <div class="photo-box"><img data-field="pkbLogo" src="" alt="Logo PKB" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0c43865b-9515-4657-969a-f99d8a81cb24.png"></div>
                    </div>
                </div>
                <div class="tagline-box">BERSAMA MENUJU KEMENANGAN</div>
            </div>
        </div>
    </div>
    <div id="print-area"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- PENAMBAHAN VARIABEL UNTUK ANIMASI LOGIN ---
        let loginBgInterval = null;

        // --- APPLICATION STATE & CONFIGURATION ---
        const appState = {
            db: {
                pendukung: [],
                settings: {
                    dprdPhotoUrl: null, // Akan diisi placeholder jika tidak ada yang diupload
                    pkbLogoUrl: null,
                    namaAnggotaDPRD: 'Nama Anggota DPRD',
                    cardTitle: 'KARTU LOYALIS PENDUKUNG SETIA',
                    // New color settings
                    frontCardColor: '#00695c', // Default green
                    backCardColor: '#00695c',  // Default green
                    frontCardTextColor: '#ffffff', // Default white
                    backCardTextColor: '#ffffff',  // Default white
                    nextIdCounters: { // New structure for ID counters per district
                        'Jongkat': 1,
                        'Segedong': 1
                    }
                }
            },
            constants: {
                MAX_SUPPORTERS: 4000,
                MAX_PRINT_PER_BATCH: 10, // Maksimal 5 pasang kartu untuk duplex, atau 10 kartu tunggal
                PLACEHOLDER_PHOTO_URL: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23ccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>', // Placeholder SVG Base64
                PLACEHOLDER_LOGO_URL: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23ccc"><path d="M12 2L4 5v6c0 5.55 3.84 10.74 9 12 3.82-1.07 6.42-3.83 7.42-7.25C20.66 11.23 20 8.07 20 5l-8-3z"/></svg>' // Placeholder SVG Base64
            },
            currentFilter: 'semua', // Can be 'semua', 'Jongkat', 'Segedong', 'Pemula', 'Dewasa', 'Senior'
            currentSearchTerm: ''
        };

        // --- DOM ELEMENTS CACHING ---
        const domElements = {
            loginPage: document.getElementById('login-page'),
            loginForm: document.getElementById('login-form'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            loginErrorMessage: document.getElementById('login-error-message'),
            appSidebar: document.getElementById('app-sidebar'),
            appMainContent: document.getElementById('app-main-content'),
            logoutLink: document.getElementById('logout-link'),
            darkModeToggleSidebar: document.getElementById('darkModeToggleSidebar'), // Sidebar dark mode toggle
            digitalClock: document.getElementById('digitalClock'),

            navLinks: document.querySelectorAll('.nav-link'),
            pages: document.querySelectorAll('.page'),
            pendukungForm: document.getElementById('pendukung-form'),
            formTitle: document.getElementById('form-title'),
            // Input fields for pendukung form
            namaInput: document.getElementById('nama'),
            nikInput: document.getElementById('nik'),
            jenisKelaminSelect: document.getElementById('jenis_kelamin'),
            tempatLahirInput: document.getElementById('tempat_lahir'),
            tanggalLahirInput: document.getElementById('tanggal_lahir'),
            kecamatanSelect: document.getElementById('kecamatan'), // New
            alamatInput: document.getElementById('alamat'),
            fotoPendukungUpload: document.getElementById('foto_pendukung_upload'),

            recapTableBody: document.getElementById('rekap-table-body'),
            editIdInput: document.getElementById('edit-id'),
            submitBtn: document.getElementById('submit-btn'),
            updateBtn: document.getElementById('update-btn'),
            cancelBtn: document.getElementById('cancel-btn'),
            reviewFrontContainer: document.getElementById('review-front-card'),
            reviewBackContainer: document.getElementById('review-back-card'),
            selectAllCheckbox: document.getElementById('select-all-checkbox'),
            printFrontBtn: document.getElementById('printFrontBtn'),
            printBackBtn: document.getElementById('printBackBtn'),
            printDuplexBtn: document.getElementById('printDuplexBtn'),
            downloadCardsBtn: document.getElementById('downloadCardsBtn'),
            downloadPdfBtn: document.getElementById('downloadPdfBtn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            settingNamaAnggotaInput: document.getElementById('setting_nama_anggota'),
            settingDprdPhotoUpload: document.getElementById('setting_dprd_photo_upload'),
            settingPkbLogoUpload: document.getElementById('setting_pkb_logo_upload'),
            settingCardTitleInput: document.getElementById('setting_card_title'),
            settingFrontCardColor: document.getElementById('setting_front_card_color'), // New
            settingBackCardColor: document.getElementById('setting_back_card_color'),   // New
            settingFrontCardTextColor: document.getElementById('setting_front_card_text_color'), // New
            settingBackCardTextColor: document.getElementById('setting_back_card_text_color'),   // New
            searchInput: document.getElementById('search-input'),
            exportCSVBtn: document.getElementById('exportCSVBtn'),
            categoryDetailsContainer: document.getElementById('category-details'),
            nextIdCountersDiv: document.getElementById('next-id-counters') // Modified
        };

        // --- UTILITY FUNCTIONS ---

        const calculateAge = (dobString) => {
            if (!dobString) return 0;
            const today = new Date();
            const dob = new Date(dobString);
            if (isNaN(dob.getTime()) || dob > today) return 0;
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            return Math.max(0, age);
        };

        const getAgeCategory = (age) => {
            if (age >= 17 && age <= 35) return 'Pemula';
            if (age >= 36 && age <= 60) return 'Dewasa';
            if (age >= 61 && age <= 95) return 'Senior';
            return 'N/A';
        };

        /**
         * MODIFIED FUNCTION
         * Formats a date string (YYYY-MM-DD) into MM/DD/YYYY format.
         * Handles timezone offsets to prevent date inaccuracies.
         */
        const formatDate = (dateString) => {
            if (!dateString) return '';
            try {
                // The HTML date input provides the date in 'YYYY-MM-DD' format.
                // Creating a new Date from this string (e.g., new Date('1994-12-21'))
                // interprets it as midnight UTC. In timezones west of UTC, this can
                // result in the previous day when using local date methods like getDate().
                // To handle this robustly, we get the local timezone offset and adjust.
                const date = new Date(dateString);
                if (isNaN(date.getTime())) throw new Error('Invalid Date');

                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const localDate = new Date(date.getTime() + userTimezoneOffset);

                const month = String(localDate.getMonth() + 1).padStart(2, '0'); // getMonth() is 0-indexed
                const day = String(localDate.getDate()).padStart(2, '0');
                const year = localDate.getFullYear();
                
                // Format as MM/DD/YYYY as requested
                return `${month}/${day}/${year}`;
            } catch (error) {
                console.error("Error formatting date:", dateString, error);
                return 'Tanggal tidak valid';
            }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                new Compressor(file, {
                    quality: 0.6,
                    maxWidth: 200,
                    maxHeight: 250,
                    mimeType: 'image/jpeg',
                    success(result) {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(result);
                    },
                    error(err) {
                        reject(err);
                    }
                });
            });
        };

        const validateNIK = (nik) => {
            const nikRegex = /^\d{16}$/;
            return nikRegex.test(nik);
        };

        // --- DATA MANAGEMENT FUNCTIONS ---

        const saveAppStateToLocalStorage = () => {
            try {
                localStorage.setItem('KPS_DB_V6', JSON.stringify(appState.db));
            } catch (e) {
                console.error("Gagal menyimpan ke localStorage:", e);
                alert("Terjadi kesalahan saat menyimpan data. Kapasitas penyimpanan mungkin penuh atau terjadi error lain.");
            }
        };

        const loadAppStateFromLocalStorage = () => {
            const storedDB = localStorage.getItem('KPS_DB_V6');
            if (storedDB) {
                appState.db = JSON.parse(storedDB);
                if (!appState.db.pendukung) appState.db.pendukung = [];
                if (!appState.db.settings) appState.db.settings = {};

                // Inisialisasi placeholder jika belum ada di settings
                if (!appState.db.settings.dprdPhotoUrl) appState.db.settings.dprdPhotoUrl = appState.constants.PLACEHOLDER_PHOTO_URL;
                if (!appState.db.settings.pkbLogoUrl) appState.db.settings.pkbLogoUrl = appState.constants.PLACEHOLDER_LOGO_URL;
                if (!appState.db.settings.namaAnggotaDPRD) appState.db.settings.namaAnggotaDPRD = 'Nama Anggota DPRD';
                if (!appState.db.settings.cardTitle) appState.db.settings.cardTitle = 'KARTU LOYALIS PENDUKUNG SETIA';
                // Initialize new color settings if not present
                if (!appState.db.settings.frontCardColor) appState.db.settings.frontCardColor = '#00695c';
                if (!appState.db.settings.backCardColor) appState.db.settings.backCardColor = '#00695c';
                if (!appState.db.settings.frontCardTextColor) appState.db.settings.frontCardTextColor = '#ffffff';
                if (!appState.db.settings.backCardTextColor) appState.db.settings.backCardTextColor = '#ffffff';

                // Initialize nextIdCounters if not present or ensure all districts have a counter
                if (!appState.db.settings.nextIdCounters) {
                    appState.db.settings.nextIdCounters = {};
                }
                // Ensure all defined districts have a counter, initialize to 1 if missing
                ['Jongkat', 'Segedong'].forEach(district => {
                    if (appState.db.settings.nextIdCounters[district] === undefined) {
                        appState.db.settings.nextIdCounters[district] = 1;
                    }
                });

            } else {
                appState.db = {
                    pendukung: [],
                    settings: {
                        dprdPhotoUrl: appState.constants.PLACEHOLDER_PHOTO_URL,
                        pkbLogoUrl: appState.constants.PLACEHOLDER_LOGO_URL,
                        namaAnggotaDPRD: 'Nama Anggota DPRD',
                        cardTitle: 'KARTU LOYALIS PENDUKUNG SETIA',
                        frontCardColor: '#00695c',
                        backCardColor: '#00695c',
                        frontCardTextColor: '#ffffff',
                        backCardTextColor: '#ffffff',
                        nextIdCounters: {
                            'Jongkat': 1,
                            'Segedong': 1
                        }
                    }
                };
                saveAppStateToLocalStorage();
            }
            updateNextIdDisplay();
            applyCardColorsToCSS(); // Apply colors on load
        };

        const updateNextIdDisplay = () => {
            if (domElements.nextIdCountersDiv) {
                domElements.nextIdCountersDiv.innerHTML = ''; // Clear previous content
                for (const district in appState.db.settings.nextIdCounters) {
                    const counterValue = appState.db.settings.nextIdCounters[district];
                    const displayValue = `PKB-LOYAL-${String(counterValue).padStart(4, '0')}`;

                    const counterHtml = `
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 5px;">
                            <label style="min-width: 80px;">${district}:</label>
                            <input type="text" value="${displayValue}" readonly aria-readonly="true" style="background-color: var(--container-bg); color: var(--text-color); flex-grow: 1; border: 1px solid var(--input-border);">
                            <button type="button" class="btn btn-danger reset-next-id-btn" data-district="${district}" aria-label="Reset nomor ID untuk ${district}">Reset ID</button>
                        </div>
                    `;
                    domElements.nextIdCountersDiv.insertAdjacentHTML('beforeend', counterHtml);
                }
                // Re-attach event listeners for newly created buttons
                document.querySelectorAll('.reset-next-id-btn').forEach(button => {
                    button.onclick = (e) => {
                        const district = e.target.dataset.district;
                        if (confirm(`PERINGATAN: Anda akan mereset nomor ID pendukung untuk ${district} ke 'PKB-LOYAL-0001'. Ini mungkin menyebabkan duplikasi ID jika ada pendukung yang ID-nya sudah terpakai sebelumnya. Lanjutkan?`)) {
                            appState.db.settings.nextIdCounters[district] = 1;
                            saveAppStateToLocalStorage();
                            updateNextIdDisplay();
                            alert(`Nomor ID pendukung untuk ${district} telah direset ke PKB-LOYAL-0001.`);
                        }
                    };
                });
            }
        };

        // Function to apply card colors to CSS variables
        const applyCardColorsToCSS = () => {
            const root = document.documentElement;
            root.style.setProperty('--card-front-bg', appState.db.settings.frontCardColor);
            root.style.setProperty('--card-back-bg', appState.db.settings.backCardColor);
            root.style.setProperty('--card-front-text-color', appState.db.settings.frontCardTextColor);
            root.style.setProperty('--card-back-text-color', appState.db.settings.backCardTextColor);
            // Adjust data label/value colors based on front card text color for better contrast
            const isFrontTextLight = isColorLight(appState.db.settings.frontCardTextColor);
            root.style.setProperty('--card-front-data-label-color', isFrontTextLight ? '#ffffff' : 'rgba(0,0,0,0.8)');
            root.style.setProperty('--card-front-data-value-color', isFrontTextLight ? '#ffffff' : 'rgba(0,0,0,0.95)');
            root.style.setProperty('--card-front-expiry-color', isFrontTextLight ? '#ffffff' : 'rgba(0,0,0,0.8)');
            root.style.setProperty('--card-back-party-name-color', appState.db.settings.backCardTextColor);
            root.style.setProperty('--card-back-member-name-color', appState.db.settings.backCardTextColor);
        };

        // Helper function to determine if a color is light or dark (for text contrast)
        const isColorLight = (hexColor) => {
            if (!hexColor || !hexColor.startsWith('#') || hexColor.length !== 7) {
                return true; // Assume light text is needed for default dark backgrounds
            }
            const r = parseInt(hexColor.substring(1, 3), 16);
            const g = parseInt(hexColor.substring(3, 5), 16);
            const b = parseInt(hexColor.substring(5, 7), 16);
            // HSP (Highly Sensitive Pooled) color model for perceived brightness
            const hsp = Math.sqrt(0.299 * (r * r) + 0.587 * (g * g) + 0.114 * (b * b));
            return hsp > 127.5; // Threshold for light/dark
        };

        // --- CARD RENDERING FUNCTIONS ---

        const createCardElement = (templateId, data) => {
            const template = document.getElementById(templateId);
            if (!template) {
                console.error(`Template dengan ID "${templateId}" tidak ditemukan.`);
                return null;
            }
            const cardClone = template.cloneNode(true);
            cardClone.removeAttribute('id');
            cardClone.style.display = '';

            const renderData = {
                ...data,
                ...appState.db.settings,
                ttl: `${data.tempat_lahir || ''}, ${formatDate(data.tanggal_lahir)}`,
                usia: `${data.usia !== undefined && data.usia !== null ? data.usia : '-'} Tahun`,
                alamat: data.alamat || '',
                berlaku: formatDate(new Date().toISOString().split('T')[0]),
                foto: data.fotoUrl || appState.constants.PLACEHOLDER_PHOTO_URL,
                dprdPhoto: appState.db.settings.dprdPhotoUrl || appState.constants.PLACEHOLDER_PHOTO_URL,
                pkbLogo: appState.db.settings.pkbLogoUrl || appState.constants.PLACEHOLDER_LOGO_URL,
                namaAnggotaDPRD: appState.db.settings.namaAnggotaDPRD || 'Nama Anggota',
                cardTitle: appState.db.settings.cardTitle || 'KARTU LOYALIS PENDUKUNG SETIA'
            };

            // Apply dynamic colors directly to the cloned card elements for html2canvas
            // This is handled by CSS variables now, but we can override for extra safety in html2canvas
            const content = cardClone.querySelector('.card-content');
            if (content) {
                 if (cardClone.classList.contains('front-card')) {
                    content.style.background = appState.db.settings.frontCardColor;
                    content.style.color = appState.db.settings.frontCardTextColor;
                    const isFrontTextLight = isColorLight(appState.db.settings.frontCardTextColor);
                    content.querySelectorAll('.data-grid span:nth-child(3n-2)').forEach(el => el.style.color = isFrontTextLight ? '#ffffff' : 'rgba(0,0,0,0.8)');
                    content.querySelectorAll('.data-grid span:nth-child(3n)').forEach(el => el.style.color = isFrontTextLight ? '#ffffff' : 'rgba(0,0,0,0.95)');
                    content.querySelector('.expiry-date').style.color = isFrontTextLight ? '#ffffff' : 'rgba(0,0,0,0.8)';
                } else if (cardClone.classList.contains('back-card')) {
                    content.style.background = appState.db.settings.backCardColor;
                    content.style.color = appState.db.settings.backCardTextColor;
                    content.querySelector('.party-name-box').style.color = appState.db.settings.backCardTextColor;
                    content.querySelector('.member-name-box').style.color = appState.db.settings.backCardTextColor;
                }
            }


            cardClone.querySelectorAll('[data-field]').forEach(el => {
                const fieldName = el.dataset.field;
                if (renderData[fieldName] !== undefined && renderData[fieldName] !== null) {
                    if (el.tagName === 'IMG') {
                        el.src = renderData[fieldName];
                        el.alt = `Gambar ${fieldName}`;
                    } else {
                        el.textContent = renderData[fieldName];
                    }
                } else {
                    if (el.tagName === 'IMG') el.src = appState.constants.PLACEHOLDER_PHOTO_URL;
                    else el.textContent = '-';
                }
            });

            const titleBox = cardClone.querySelector('.title-box');
            if (titleBox && renderData['cardTitle']) {
                titleBox.textContent = renderData['cardTitle'];
            }
            return cardClone;
        };

        const updateCardPreview = (pendukungData) => {
            domElements.reviewFrontContainer.innerHTML = '';
            domElements.reviewBackContainer.innerHTML = '';

            const frontCardElement = createCardElement('frontCardTemplate', pendukungData);
            if (frontCardElement) {
                domElements.reviewFrontContainer.appendChild(frontCardElement);
            } else {
                domElements.reviewFrontContainer.innerHTML = `<p style="text-align: center; width: 100%; padding: 20px; color: var(--text-color);">Pratinjau Kartu Depan Gagal Dimuat.</p>`;
            }

            const backCardElement = createCardElement('backCardTemplate', pendukungData);
            if (backCardElement) {
                domElements.reviewBackContainer.appendChild(backCardElement);
            } else {
                domElements.reviewBackContainer.innerHTML = `<p style="text-align: center; width: 100%; padding: 20px; color: var(--text-color);">Pratinjau Kartu Belakang Gagal Dimuat.</p>`;
            }
        };

        // --- TABLE RENDERING FUNCTIONS ---

        let ageChartInstance;

        const renderRecapTable = () => {
            domElements.recapTableBody.innerHTML = '';

            const filteredPendukung = appState.db.pendukung.filter(pendukung => {
                let matchesFilter = true;

                const ageCategory = getAgeCategory(pendukung.usia);
                if (['Pemula', 'Dewasa', 'Senior'].includes(appState.currentFilter)) {
                    matchesFilter = (ageCategory === appState.currentFilter);
                } 
                else if (['Jongkat', 'Segedong'].includes(appState.currentFilter)) {
                    matchesFilter = (pendukung.kecamatan === appState.currentFilter);
                }
                
                if (!matchesFilter) return false;

                if (appState.currentSearchTerm) {
                    const lowerSearchTerm = appState.currentSearchTerm.toLowerCase();
                    const matchesSearch =
                        (pendukung.nik && pendukung.nik.toLowerCase().includes(lowerSearchTerm)) ||
                        (pendukung.no_pendukung && pendukung.no_pendukung.toLowerCase().includes(lowerSearchTerm)) ||
                        (pendukung.nama && pendukung.nama.toLowerCase().includes(lowerSearchTerm)) ||
                        (pendukung.alamat && pendukung.alamat.toLowerCase().includes(lowerSearchTerm)) ||
                        (pendukung.kecamatan && pendukung.kecamatan.toLowerCase().includes(lowerSearchTerm));
                    return matchesSearch;
                }
                return true;
            });

            if (filteredPendukung.length === 0) {
                domElements.recapTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Tidak ada data ditemukan.</td></tr>';
                domElements.selectAllCheckbox.checked = false;
                domElements.selectAllCheckbox.disabled = true;
                renderAgeChart(); 
                renderCategoryDetails();
                return;
            }

            domElements.selectAllCheckbox.disabled = false;

            filteredPendukung.forEach((pendukung, displayIndex) => {
                const row = domElements.recapTableBody.insertRow();
                row.innerHTML = `
                    <td><input type="checkbox" class="select-card-checkbox" value="${pendukung.id}" aria-label="Pilih kartu ${pendukung.nama}"></td>
                    <td>${displayIndex + 1}</td>
                    <td>${pendukung.no_pendukung || '-'}</td>
                    <td>${pendukung.nama || '-'}</td>
                    <td>${pendukung.nik || '-'}</td> 
                    <td>${pendukung.kecamatan || '-'}</td>
                    <td>${pendukung.alamat || '-'}</td>
                    <td>${pendukung.usia !== undefined && pendukung.usia !== null ? pendukung.usia : '-'}</td>
                    <td>${getAgeCategory(pendukung.usia)}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" data-id="${pendukung.id}" title="Edit" aria-label="Edit data ${pendukung.nama}">Edit</button>
                        <button class="delete-btn" data-id="${pendukung.id}" title="Hapus" aria-label="Hapus data ${pendukung.nama}">Hapus</button>
                    </td>`;
            });

            renderAgeChart();
            renderCategoryDetails();
        };

        const renderCategoryDetails = () => {
            const categories = ['Pemula', 'Dewasa', 'Senior', 'N/A'];
            domElements.categoryDetailsContainer.innerHTML = '';

            categories.forEach(category => {
                const pendukungInCategory = appState.db.pendukung.filter(pendukung => getAgeCategory(pendukung.usia) === category);

                if (pendukungInCategory.length > 0) {
                    const section = document.createElement('div');
                    section.className = 'category-section';
                    section.innerHTML = `<h3>${category} (${pendukungInCategory.length} Pendukung)</h3>`;

                    const list = document.createElement('ul');
                    list.className = 'category-list';
                    pendukungInCategory.forEach(pendukung => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${pendukung.nama}</strong> (ID: ${pendukung.no_pendukung}, NIK: ${pendukung.nik}, Usia: ${pendukung.usia}, Kecamatan: ${pendukung.kecamatan})`;
                        list.appendChild(li);
                    });
                    section.appendChild(list);
                    domElements.categoryDetailsContainer.appendChild(section);
                }
            });

            if (!domElements.categoryDetailsContainer.innerHTML) {
                domElements.categoryDetailsContainer.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
            }
        };

        const renderAgeChart = () => {
            const ctx = document.getElementById('ageChart')?.getContext('2d');
            if (!ctx) return;

            const ageCategories = { Pemula: 0, Dewasa: 0, Senior: 0, 'N/A': 0 };
            appState.db.pendukung.forEach(pendukung => {
                const category = getAgeCategory(pendukung.usia);
                ageCategories[category]++;
            });

            if (ageChartInstance) {
                ageChartInstance.destroy();
            }

            ageChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pemula (17-35)', 'Dewasa (36-60)', 'Senior (61-95)', 'N/A'],
                    datasets: [{
                        label: 'Jumlah Pendukung',
                        data: [
                            ageCategories.Pemula,
                            ageCategories.Dewasa,
                            ageCategories.Senior,
                            ageCategories['N/A']
                        ],
                        backgroundColor: [
                            'rgba(0, 105, 92, 0.8)',
                            'rgba(179, 135, 40, 0.8)',
                            'rgba(108, 117, 125, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 105, 92, 1)',
                            'rgba(179, 135, 40, 1)',
                            'rgba(108, 117, 125, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Jumlah Pendukung' },
                            ticks: { precision: 0 }
                        },
                        x: {
                            title: { display: true, text: 'Kategori Usia' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Distribusi Kategori Usia Pendukung' }
                    }
                }
            });
        };

        // --- FORM HANDLING FUNCTIONS ---

        const resetPendukungForm = () => {
            domElements.pendukungForm.reset();
            domElements.editIdInput.value = '';
            domElements.formTitle.textContent = 'Tambah Pendukung Baru';
            domElements.submitBtn.classList.remove('hidden');
            domElements.updateBtn.classList.add('hidden');
            domElements.fotoPendukungUpload.value = '';
            updateCardPreview({});
            domElements.pendukungForm.dataset.currentPreviewData = '';
        };

        const handlePendukungFormSubmit = async (e) => {
            e.preventDefault();

            if (!domElements.pendukungForm.checkValidity()) {
                domElements.pendukungForm.reportValidity();
                return;
            }

            const isEditing = domElements.editIdInput.value !== '';
            if (!isEditing && appState.db.pendukung.length >= appState.constants.MAX_SUPPORTERS) {
                alert(`Batas maksimal ${appState.constants.MAX_SUPPORTERS} pendukung telah tercapai.`);
                return;
            }

            const pendukungData = {
                nama: domElements.namaInput.value.trim(),
                nik: domElements.nikInput.value.trim(),
                jenis_kelamin: domElements.jenisKelaminSelect.value,
                tempat_lahir: domElements.tempatLahirInput.value.trim(),
                tanggal_lahir: domElements.tanggalLahirInput.value,
                kecamatan: domElements.kecamatanSelect.value,
                alamat: domElements.alamatInput.value.trim(),
            };
            pendukungData.usia = calculateAge(pendukungData.tanggal_lahir);

            if (!validateNIK(pendukungData.nik)) {
                alert('Format NIK tidak valid. NIK harus terdiri dari 16 digit angka.');
                domElements.nikInput.focus();
                return;
            }
            
            if (!pendukungData.kecamatan) {
                alert('Harap pilih Kecamatan.');
                domElements.kecamatanSelect.focus();
                return;
            }

            const existingId = isEditing ? parseInt(domElements.editIdInput.value, 10) : null;
            const nikExisting = appState.db.pendukung.find(p => p.nik === pendukungData.nik && (!isEditing || p.id !== existingId));
            if (nikExisting) {
                alert(`Error: NIK "${pendukungData.nik}" sudah terdaftar untuk pendukung lain.`);
                domElements.nikInput.focus();
                return;
            }

            let fotoUrl = null;
            const fotoFile = domElements.fotoPendukungUpload.files[0];

            if (fotoFile) {
                try {
                    fotoUrl = await compressImage(fotoFile);
                } catch (err) {
                    alert('Gagal mengompresi foto pendukung. Coba lagi.');
                    console.error('Compression error:', err);
                    return;
                }
            } else if (isEditing) {
                const existingPendukung = appState.db.pendukung.find(p => p.id === existingId);
                if (existingPendukung) {
                    fotoUrl = existingPendukung.fotoUrl;
                }
            }
            pendukungData.fotoUrl = fotoUrl;


            if (!isEditing) {
                let currentDistrictCounter = appState.db.settings.nextIdCounters[pendukungData.kecamatan];
                if (currentDistrictCounter === undefined) {
                    currentDistrictCounter = 1;
                }
                
                let newPendukungNo = `PKB-LOYAL-${String(currentDistrictCounter).padStart(4, '0')}`;
                
                while (appState.db.pendukung.some(p => p.kecamatan === pendukungData.kecamatan && p.no_pendukung === newPendukungNo)) {
                    currentDistrictCounter++;
                    newPendukungNo = `PKB-LOYAL-${String(currentDistrictCounter).padStart(4, '0')}`;
                }
                
                appState.db.settings.nextIdCounters[pendukungData.kecamatan] = currentDistrictCounter + 1;

                pendukungData.id = appState.db.pendukung.length > 0 ? Math.max(...appState.db.pendukung.map(p => p.id || 0)) + 1 : 1;
                pendukungData.no_pendukung = newPendukungNo;
                
                appState.db.pendukung.push(pendukungData);
                alert('Pendukung baru berhasil ditambahkan!');
            } else {
                const indexToUpdate = appState.db.pendukung.findIndex(p => p.id === existingId);
                if (indexToUpdate === -1) {
                    alert('Kesalahan: Data pendukung yang diedit tidak ditemukan.');
                    return;
                }
                pendukungData.id = existingId;
                
                if (appState.db.pendukung[indexToUpdate].kecamatan !== pendukungData.kecamatan) {
                    let newDistrictCounter = appState.db.settings.nextIdCounters[pendukungData.kecamatan];
                    if (newDistrictCounter === undefined) {
                        newDistrictCounter = 1;
                    }

                    let newPendukungNo = `PKB-LOYAL-${String(newDistrictCounter).padStart(4, '0')}`;
                    while (appState.db.pendukung.some(p => p.kecamatan === pendukungData.kecamatan && p.no_pendukung === newPendukungNo)) {
                        newDistrictCounter++;
                        newPendukungNo = `PKB-LOYAL-${String(newDistrictCounter).padStart(4, '0')}`;
                    }
                    appState.db.settings.nextIdCounters[pendukungData.kecamatan] = newDistrictCounter + 1;
                    pendukungData.no_pendukung = newPendukungNo;
                } else {
                    pendukungData.no_pendukung = appState.db.pendukung[indexToUpdate].no_pendukung;
                }
                
                appState.db.pendukung[indexToUpdate] = pendukungData;
                alert('Data pendukung berhasil diperbarui!');
            }

            saveAppStateToLocalStorage();
            renderRecapTable();
            resetPendukungForm();
            updateNextIdDisplay();
        };

        const exportPendukungToCSV = () => {
            const headers = ['ID Internal', 'No Pendukung', 'Nama', 'NIK', 'Jenis Kelamin', 'Tempat Lahir', 'Tanggal Lahir', 'Kecamatan', 'Alamat', 'Usia'];
            const csvRows = [headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',')];

            appState.db.pendukung.forEach(pendukung => {
                const row = [
                    pendukung.id,
                    `"${(pendukung.no_pendukung || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.nama || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.nik || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.jenis_kelamin || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.tempat_lahir || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.tanggal_lahir || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.kecamatan || '-').replace(/"/g, '""')}"`,
                    `"${(pendukung.alamat || '-').replace(/"/g, '""')}"`,
                    pendukung.usia !== undefined && pendukung.usia !== null ? pendukung.usia : '-'
                ];
                csvRows.push(row.join(','));
            });
            const csv = csvRows.join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data_pendukung_kps.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const downloadSelectedCards = async () => {
            const selectedCheckboxes = document.querySelectorAll('.select-card-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Harap pilih kartu yang ingin di-download terlebih dahulu.');
                return;
            }

            alert(`Mempersiapkan PDF untuk ${selectedCheckboxes.length} kartu. Proses ini mungkin memakan waktu beberapa saat...`);

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const CARD_WIDTH_MM = 85.6;
            const CARD_HEIGHT_MM = 53.98;
            const GAP_MM = 2; // Gap between front and back card
            const PAIR_WIDTH_MM = (CARD_WIDTH_MM * 2) + GAP_MM;

            const PAGE_WIDTH = pdf.internal.pageSize.getWidth();
            const PAGE_HEIGHT = pdf.internal.pageSize.getHeight();
            const MARGIN_X = (PAGE_WIDTH - PAIR_WIDTH_MM) / 2; // Center the pair horizontally
            const MARGIN_Y = 10;
            const VERTICAL_SPACING = 5; // Space between rows of cards

            let yPos = MARGIN_Y;
            let cardCount = 0;

            for (const checkbox of selectedCheckboxes) {
                const cardId = parseInt(checkbox.value, 10);
                const pendukungData = appState.db.pendukung.find(p => p.id === cardId);
                if (!pendukungData) continue;

                const frontCard = createCardElement('frontCardTemplate', pendukungData);
                const backCard = createCardElement('backCardTemplate', pendukungData);

                if (!frontCard || !backCard) continue;

                // Create a temporary container to render the pair side-by-side
                const tempContainer = document.createElement('div');
                tempContainer.style.display = 'flex';
                tempContainer.style.gap = `${GAP_MM}mm`;
                tempContainer.style.width = 'fit-content'; // Let it size to its content
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px'; // Hide from view
                tempContainer.style.top = '-9999px';
                document.body.appendChild(tempContainer);
                tempContainer.appendChild(frontCard);
                tempContainer.appendChild(backCard);


                try {
                    // Check if adding this card will exceed the page height, if so, add a new page
                    if (cardCount > 0 && yPos + CARD_HEIGHT_MM > PAGE_HEIGHT - MARGIN_Y) {
                        pdf.addPage();
                        yPos = MARGIN_Y; // Reset Y position for the new page
                    }
                    
                    const canvas = await html2canvas(tempContainer, {
                        scale: 3, // Higher scale for better quality
                        useCORS: true,
                        logging: false,
                        backgroundColor: null // Use transparent background
                    });
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);

                    // Add the image of the card pair to the PDF, centered
                    pdf.addImage(imgData, 'JPEG', MARGIN_X, yPos, PAIR_WIDTH_MM, CARD_HEIGHT_MM);

                    // Update Y position for the next card pair
                    yPos += CARD_HEIGHT_MM + VERTICAL_SPACING;
                    cardCount++;

                } catch (error) {
                    console.error('Error generating card image for PDF:', error);
                    alert('Gagal membuat gambar kartu untuk PDF. Pastikan semua gambar dimuat dengan benar.');
                } finally {
                    document.body.removeChild(tempContainer); // Clean up the temporary element
                }
            }

            if (cardCount > 0) {
                pdf.save('kartu-pendukung-terpilih.pdf');
            } else {
                alert('Tidak ada kartu yang berhasil diproses untuk PDF.');
            }

            // Uncheck all boxes after download is complete
            domElements.selectAllCheckbox.checked = false;
            document.querySelectorAll('.select-card-checkbox').forEach(cb => cb.checked = false);
        };

        const printSelectedCards = (printMode) => {
            const selectedCheckboxes = document.querySelectorAll('.select-card-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Harap pilih kartu yang ingin dicetak terlebih dahulu.');
                return;
            }
            if (selectedCheckboxes.length > appState.constants.MAX_PRINT_PER_BATCH) {
                alert(`Anda hanya dapat mencetak maksimal ${appState.constants.MAX_PRINT_PER_BATCH} kartu dalam satu sesi.`);
                return;
            }

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';

            let cardsPerPrintPage = appState.constants.MAX_PRINT_PER_BATCH; 
            let currentPage = document.createElement('div');
            currentPage.className = 'print-page';
            printArea.appendChild(currentPage);

            let cardOnCurrentPage = 0;

            selectedCheckboxes.forEach(checkbox => {
                const cardId = parseInt(checkbox.value, 10);
                const pendukungData = appState.db.pendukung.find(p => p.id === cardId);

                if (!pendukungData) {
                    console.warn(`Data untuk kartu ID ${cardId} tidak ditemukan.`);
                    return;
                }

                if (cardOnCurrentPage >= cardsPerPrintPage) {
                    currentPage = document.createElement('div');
                    currentPage.className = 'print-page';
                    printArea.appendChild(currentPage);
                    cardOnCurrentPage = 0;
                }

                if (printMode === 'duplex') {
                    const frontCard = createCardElement('frontCardTemplate', pendukungData);
                    const backCard = createCardElement('backCardTemplate', pendukungData);
                    const duplexPair = document.createElement('div');
                    duplexPair.className = 'duplex-pair';
                    if (frontCard) duplexPair.appendChild(frontCard);
                    if (backCard) duplexPair.appendChild(backCard);
                    currentPage.appendChild(duplexPair);
                    cardOnCurrentPage++;
                } else if (printMode === 'front') {
                    const frontCard = createCardElement('frontCardTemplate', pendukungData);
                    if (frontCard) currentPage.appendChild(frontCard);
                    cardOnCurrentPage++;
                } else if (printMode === 'back') {
                    const backCard = createCardElement('backCardTemplate', pendukungData);
                    if (backCard) currentPage.appendChild(backCard);
                    cardOnCurrentPage++;
                }
            });

            window.print();

            domElements.selectAllCheckbox.checked = false;
            document.querySelectorAll('.select-card-checkbox').forEach(cb => cb.checked = false);
        };

        const downloadPendukungToPDF = async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            const margin = 10;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let yOffset = margin;

            pdf.setFontSize(18);
            pdf.text("Rekapitulasi Data Pendukung", margin, yOffset);
            yOffset += 10;

            const tableWrapper = document.querySelector('#rekap .rekap-table-wrapper');
            if (!tableWrapper) {
                alert("Tabel rekapitulasi tidak ditemukan.");
                return;
            }

            const originalTable = tableWrapper.querySelector('table');
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = (pageWidth - 2 * margin) + 'mm';
            document.body.appendChild(tempDiv);

            const tableClone = originalTable.cloneNode(true);
            tableClone.querySelectorAll('th:first-child, td:first-child').forEach(el => el.remove());
            tableClone.querySelectorAll('th:last-child, td:last-child').forEach(el => el.remove());
            tempDiv.appendChild(tableClone);

            try {
                const canvas = await html2canvas(tempDiv, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pageWidth - 2 * margin;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = yOffset;

                pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position);

                while (heightLeft > 0) {
                    pdf.addPage();
                    position = -heightLeft + margin;
                    pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                yOffset = (imgHeight % pageHeight) + margin;
                if (yOffset < margin) yOffset = margin;
            } catch (error) {
                console.error("Error rendering table to canvas:", error);
                alert("Gagal merender tabel ke PDF. Silakan coba lagi.");
            } finally {
                document.body.removeChild(tempDiv);
            }

            const ageChartCanvas = document.getElementById('ageChart');
            if (ageChartCanvas) {
                if (yOffset + 80 > pageHeight) {
                    pdf.addPage();
                    yOffset = margin;
                } else {
                    yOffset += 15;
                }

                pdf.setFontSize(16);
                pdf.text("Distribusi Kategori Usia Pendukung", margin, yOffset);
                yOffset += 10;

                const chartImgData = ageChartCanvas.toDataURL('image/png');
                const chartImgWidth = 150;
                const chartImgHeight = ageChartCanvas.height * chartImgWidth / ageChartCanvas.width;
                pdf.addImage(chartImgData, 'PNG', margin, yOffset, chartImgWidth, chartImgHeight);
                yOffset += chartImgHeight + 10;
            }
            
            pdf.save("rekap_data_pendukung.pdf");
        };

        // --- NAVIGATION FUNCTIONS ---

        const handleNavigation = (e) => {
            e.preventDefault();
            const targetId = e.currentTarget.getAttribute('href').substring(1);

            domElements.pages.forEach(page => page.classList.remove('active'));
            domElements.navLinks.forEach(link => link.classList.remove('active'));

            document.getElementById(targetId).classList.add('active');
            e.currentTarget.classList.add('active');

            if (targetId === 'input') {
                resetPendukungForm();
            } else if (targetId === 'rekap') {
                renderRecapTable();
            } else if (targetId === 'pengaturan') {
                domElements.settingNamaAnggotaInput.value = appState.db.settings.namaAnggotaDPRD;
                domElements.settingCardTitleInput.value = appState.db.settings.cardTitle;
                domElements.settingFrontCardColor.value = appState.db.settings.frontCardColor;
                domElements.settingBackCardColor.value = appState.db.settings.backCardColor;
                domElements.settingFrontCardTextColor.value = appState.db.settings.frontCardTextColor;
                domElements.settingBackCardTextColor.value = appState.db.settings.backCardTextColor;
                updateNextIdDisplay();
            }
        };

        // --- AUTHENTICATION FUNCTIONS ---
        const startLoginBackgroundAnimation = () => {
            if (loginBgInterval) clearInterval(loginBgInterval);

            const loginContainer = domElements.loginPage;
            if (!loginContainer) return;

            const bgColors = ['#004d40', '#00695c', '#212529', '#00796b', '#004d40'];
            let colorIndex = 0;

            loginContainer.style.backgroundColor = bgColors[colorIndex];

            loginBgInterval = setInterval(() => {
                colorIndex = (colorIndex + 1) % bgColors.length;
                loginContainer.style.backgroundColor = bgColors[colorIndex];
            }, 5000);
        };

        const performLogin = (username, password) => {
            const USER = 'admin';
            const PASS = 'admin123';

            if (username === USER && password === PASS) {
                if (loginBgInterval) {
                    clearInterval(loginBgInterval);
                    loginBgInterval = null;
                }
                sessionStorage.setItem('loggedIn', 'true');
                domElements.loginPage.classList.add('hidden');
                domElements.appSidebar.classList.remove('hidden');
                domElements.appMainContent.classList.remove('hidden');
                initializeAppContent();
            } else {
                domElements.loginErrorMessage.classList.remove('hidden');
            }
        };

        const performLogout = () => {
            if (confirm("Apakah Anda yakin ingin keluar dari aplikasi?")) {
                sessionStorage.removeItem('loggedIn');
                domElements.loginPage.classList.remove('hidden');
                domElements.appSidebar.classList.add('hidden');
                domElements.appMainContent.classList.add('hidden');
                domElements.usernameInput.value = '';
                domElements.passwordInput.value = '';
                domElements.loginErrorMessage.classList.add('hidden');
                startLoginBackgroundAnimation();
            }
        };

        // --- DIGITAL CLOCK FUNCTIONS ---
        const updateDigitalClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            if (domElements.digitalClock) {
                domElements.digitalClock.textContent = `${hours}:${minutes}:${seconds}`;
            }
        };

        // --- DARK MODE FUNCTIONS ---
        const toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateDarkModeToggleIcon(isDarkMode);
        };

        const loadDarkModeSetting = () => {
            const darkModeSetting = localStorage.getItem('darkMode');
            if (darkModeSetting === 'enabled') {
                document.body.classList.add('dark-mode');
                updateDarkModeToggleIcon(true);
            } else {
                document.body.classList.remove('dark-mode');
                updateDarkModeToggleIcon(false);
            }
        };

        const updateDarkModeToggleIcon = (isDarkMode) => {
            const sunIconPath = `<path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.183a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 001.06 1.06l1.591-1.59zM12 18.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V19.5a.75.75 0 01.75-.75zM4.929 6.183a.75.75 0 00-1.06 1.06l1.59 1.59a.75.75 0 101.06-1.06L4.929 6.183zm13.432 5.714a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H19.5a.75.75 0 01-.75-.75zM4.5 12a.75.75 0 01-.75-.75H2.25a.75.75 0 010-1.5H3.75a.75.75 0 01.75.75zM6.183 18.894a.75.75 0 001.06-1.06l-1.59-1.59a.75.75 0 00-1.06 1.06l1.59 1.59z" />`;
            const moonIconPath = `<path d="M9.598 1.591a.75.75 0 01.785-.175 10.004 10.004 0 00-9.95 9.95c0 .2-.014.4-.045.592A.75.75 0 011.5 12a.75.75 0 00.75.75h2.25a.75.75 0 010 1.5H2.25A.75.75 0 001.5 15a.75.75 0 01-.175.785 10.004 10.004 0 009.95 9.95c.192-.031.392-.045.592-.045a.75.75 0 01.75.75v2.25a.75.75 0 001.5 0v-2.25a.75.75 0 01.75-.75h2.25a.75.75 0 000-1.5h-2.25a.75.75 0 01-.75-.75V15a.75.75 0 01.175-.785 10.004 10.004 0 009.95-9.95c-.031-.192-.045-.392-.045-.592a.75.75 0 01.75-.75v-2.25a.75.75 0 00-1.5 0v2.25a.75.75 0 01-.75.75h-2.25a.75.75 0 000 1.5h2.25a.75.75 0 01.75.75V9a.75.75 0 01-.175.785 10.004 10.004 0 00-9.95-9.95c-.192.031-.392.045-.592.045zM12 7.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9z" />`;

            // Update sidebar toggle
            const sidebarToggleSvg = domElements.darkModeToggleSidebar.querySelector('svg');
            const sidebarToggleSpan = domElements.darkModeToggleSidebar.querySelector('span');
            if (sidebarToggleSvg) {
                sidebarToggleSvg.innerHTML = isDarkMode ? moonIconPath : sunIconPath;
            }
            if (sidebarToggleSpan) {
                sidebarToggleSpan.textContent = isDarkMode ? 'Mode Terang' : 'Mode Gelap';
            }
        };

        // --- EVENT LISTENERS SETUP ---

        const setupEventListeners = () => {
            domElements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                performLogin(domElements.usernameInput.value, domElements.passwordInput.value);
            });

            domElements.logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                performLogout();
            });

            domElements.darkModeToggleSidebar.addEventListener('click', toggleDarkMode); // Sidebar dark mode toggle event listener

            domElements.navLinks.forEach(link => link.addEventListener('click', handleNavigation));
            domElements.pendukungForm.addEventListener('submit', handlePendukungFormSubmit);
            domElements.updateBtn.addEventListener('click', handlePendukungFormSubmit);
            domElements.cancelBtn.addEventListener('click', resetPendukungForm);
            domElements.printFrontBtn.addEventListener('click', () => printSelectedCards('front'));
            domElements.printBackBtn.addEventListener('click', () => printSelectedCards('back'));
            domElements.printDuplexBtn.addEventListener('click', () => printSelectedCards('duplex'));
            domElements.downloadCardsBtn.addEventListener('click', downloadSelectedCards);
            domElements.downloadPdfBtn.addEventListener('click', downloadPendukungToPDF);

            domElements.recapTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const pendukungToEdit = appState.db.pendukung.find(p => p.id === id);

                    if (pendukungToEdit) {
                        document.querySelector('.nav-link[href="#input"]').click();

                        domElements.namaInput.value = pendukungToEdit.nama || '';
                        domElements.nikInput.value = pendukungToEdit.nik || '';
                        domElements.jenisKelaminSelect.value = pendukungToEdit.jenis_kelamin || '';
                        domElements.tempatLahirInput.value = pendukungToEdit.tempat_lahir || '';
                        domElements.tanggalLahirInput.value = pendukungToEdit.tanggal_lahir || '';
                        domElements.kecamatanSelect.value = pendukungToEdit.kecamatan || '';
                        domElements.alamatInput.value = pendukungToEdit.alamat || '';
                        
                        domElements.editIdInput.value = pendukungToEdit.id;

                        domElements.formTitle.textContent = 'Edit Data Pendukung';
                        domElements.submitBtn.classList.add('hidden');
                        domElements.updateBtn.classList.remove('hidden');

                        const previewData = { ...pendukungToEdit, fotoUrl: pendukungToEdit.fotoUrl || null };
                        updateCardPreview(previewData);
                        domElements.pendukungForm.dataset.currentPreviewData = JSON.stringify(previewData);
                    } else {
                        alert('Gagal memuat data untuk diedit. Data tidak ditemukan.');
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const pendukungToDelete = appState.db.pendukung.find(p => p.id === id);
                    if (pendukungToDelete && confirm(`Apakah Anda yakin ingin menghapus ${pendukungToDelete.nama}? Aksi ini tidak dapat dibatalkan.`)) {
                        appState.db.pendukung = appState.db.pendukung.filter(p => p.id !== id);
                        saveAppStateToLocalStorage();
                        renderRecapTable();
                        if (parseInt(domElements.editIdInput.value, 10) === id) {
                            resetPendukungForm();
                        }
                    }
                }
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('btn-primary');
                        b.classList.add('btn-secondary');
                    });
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');

                    appState.currentFilter = btn.dataset.filter;
                    renderRecapTable();
                });
            });

            domElements.searchInput.addEventListener('keyup', (e) => {
                appState.currentSearchTerm = e.target.value;
                renderRecapTable();
            });

            domElements.saveSettingsBtn.addEventListener('click', async () => {
                appState.db.settings.namaAnggotaDPRD = domElements.settingNamaAnggotaInput.value.trim();
                appState.db.settings.cardTitle = domElements.settingCardTitleInput.value.trim();
                appState.db.settings.frontCardColor = domElements.settingFrontCardColor.value;
                appState.db.settings.backCardColor = domElements.settingBackCardColor.value;
                appState.db.settings.frontCardTextColor = domElements.settingFrontCardTextColor.value;
                appState.db.settings.backCardTextColor = domElements.settingBackCardTextColor.value;

                let dprdPhotoUrl = null;
                const dprdFile = domElements.settingDprdPhotoUpload.files[0];
                if (dprdFile) {
                    try {
                        dprdPhotoUrl = await compressImage(dprdFile);
                    } catch (err) {
                        alert('Gagal mengompresi foto anggota DPRD. Coba lagi.');
                        console.error('Compression error:', err);
                    }
                } else {
                    dprdPhotoUrl = appState.db.settings.dprdPhotoUrl; 
                }
                appState.db.settings.dprdPhotoUrl = dprdPhotoUrl;

                let pkbLogoUrl = null;
                const pkbFile = domElements.settingPkbLogoUpload.files[0];
                if (pkbFile) {
                    try {
                        pkbLogoUrl = await compressImage(pkbFile);
                    } catch (err) {
                        alert('Gagal mengompresi logo PKB. Coba lagi.');
                        console.error('Compression error:', err);
                    }
                } else {
                    pkbLogoUrl = appState.db.settings.pkbLogoUrl; 
                }
                appState.db.settings.pkbLogoUrl = pkbLogoUrl;

                saveAppStateToLocalStorage();
                applyCardColorsToCSS();

                const currentPreviewDataString = domElements.pendukungForm.dataset.currentPreviewData;
                if (currentPreviewDataString) {
                    const dataForPreview = JSON.parse(currentPreviewDataString);
                    updateCardPreview(dataForPreview);
                }
                alert('Pengaturan kartu berhasil disimpan!');
            });

            [domElements.settingFrontCardColor, domElements.settingBackCardColor, domElements.settingFrontCardTextColor, domElements.settingBackCardTextColor].forEach(input => {
                input.addEventListener('input', () => {
                    appState.db.settings.frontCardColor = domElements.settingFrontCardColor.value;
                    appState.db.settings.backCardColor = domElements.settingBackCardColor.value;
                    appState.db.settings.frontCardTextColor = domElements.settingFrontCardTextColor.value;
                    appState.db.settings.backCardTextColor = domElements.settingBackCardTextColor.value;
                    applyCardColorsToCSS();
                    const currentPreviewDataString = domElements.pendukungForm.dataset.currentPreviewData;
                    if (currentPreviewDataString) {
                        updateCardPreview(JSON.parse(currentPreviewDataString));
                    }
                });
            });

            domElements.selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.select-card-checkbox').forEach(cb => {
                    cb.checked = isChecked;
                });
            });

            domElements.exportCSVBtn.addEventListener('click', exportPendukungToCSV);

            ['nama', 'nik', 'jenis_kelamin', 'tempat_lahir', 'tanggal_lahir', 'kecamatan', 'alamat'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    const selectedKecamatan = domElements.kecamatanSelect.value;
                    const nextIdForPreview = appState.db.settings.nextIdCounters[selectedKecamatan] || 1;

                    const noPendukungPreview = domElements.editIdInput.value 
                        ? appState.db.pendukung.find(p => p.id === parseInt(domElements.editIdInput.value, 10))?.no_pendukung 
                        : `PKB-LOYAL-${String(nextIdForPreview).padStart(4, '0')}`;

                    const formDataForPreview = {
                        nama: domElements.namaInput.value,
                        nik: domElements.nikInput.value,
                        jenis_kelamin: domElements.jenisKelaminSelect.value,
                        tempat_lahir: domElements.tempatLahirInput.value,
                        tanggal_lahir: domElements.tanggalLahirInput.value,
                        kecamatan: domElements.kecamatanSelect.value,
                        alamat: domElements.alamatInput.value,
                        usia: calculateAge(domElements.tanggalLahirInput.value),
                        fotoUrl: domElements.fotoPendukungUpload.files[0] 
                            ? URL.createObjectURL(domElements.fotoPendukungUpload.files[0]) 
                            : (appState.db.pendukung.find(p => p.id === parseInt(domElements.editIdInput.value, 10))?.fotoUrl || null),
                        no_pendukung: noPendukungPreview
                    };
                    updateCardPreview(formDataForPreview);
                    domElements.pendukungForm.dataset.currentPreviewData = JSON.stringify(formDataForPreview);
                });
            });

            domElements.fotoPendukungUpload.addEventListener('change', async (e) => {
                const fotoFile = e.target.files[0];
                let previewFotoUrl = null;
                if (fotoFile) {
                    previewFotoUrl = URL.createObjectURL(fotoFile);
                }

                const currentPreviewDataString = domElements.pendukungForm.dataset.currentPreviewData;
                let currentPreviewData = {};
                if (currentPreviewDataString) {
                    currentPreviewData = JSON.parse(currentPreviewDataString);
                } else {
                    const selectedKecamatan = domElements.kecamatanSelect.value;
                    const nextIdForPreview = appState.db.settings.nextIdCounters[selectedKecamatan] || 1;

                    currentPreviewData = {
                        nama: domElements.namaInput.value,
                        nik: domElements.nikInput.value,
                        jenis_kelamin: domElements.jenisKelaminSelect.value,
                        tempat_lahir: domElements.tempatLahirInput.value,
                        tanggal_lahir: domElements.tanggalLahirInput.value,
                        kecamatan: domElements.kecamatanSelect.value,
                        alamat: domElements.alamatInput.value,
                        usia: calculateAge(domElements.tanggalLahirInput.value),
                        no_pendukung: `PKB-LOYAL-${String(nextIdForPreview).padStart(4, '0')}`
                    };
                }
                currentPreviewData.fotoUrl = previewFotoUrl;
                updateCardPreview(currentPreviewData);
                domElements.pendukungForm.dataset.currentPreviewData = JSON.stringify(currentPreviewData);
            });
        };

        // --- INITIALIZATION ---

        const initializeAppContent = () => {
            loadAppStateFromLocalStorage();
            domElements.settingNamaAnggotaInput.value = appState.db.settings.namaAnggotaDPRD;
            domElements.settingCardTitleInput.value = appState.db.settings.cardTitle;
            domElements.settingFrontCardColor.value = appState.db.settings.frontCardColor;
            domElements.settingBackCardColor.value = appState.db.settings.backCardColor;
            domElements.settingFrontCardTextColor.value = appState.db.settings.frontCardTextColor;
            domElements.settingBackCardTextColor.value = appState.db.settings.backCardTextColor;
            
            applyCardColorsToCSS();
            updateNextIdDisplay();
            renderRecapTable();
            resetPendukungForm();
            
            document.querySelector('.nav-link.active')?.click();
            setInterval(updateDigitalClock, 1000); // Start clock
        };

        const checkLoginStatus = () => {
            loadDarkModeSetting(); // Load dark mode setting before showing anything
            if (sessionStorage.getItem('loggedIn') === 'true') {
                domElements.loginPage.classList.add('hidden');
                domElements.appSidebar.classList.remove('hidden');
                domElements.appMainContent.classList.remove('hidden');
                initializeAppContent();
            } else {
                domElements.loginPage.classList.remove('hidden');
                domElements.appSidebar.classList.add('hidden');
                domElements.appMainContent.classList.add('hidden');
                startLoginBackgroundAnimation();
            }
        };

        // Initial setup
        setupEventListeners();
        checkLoginStatus();
    });
    </script>
</body>
</html>
